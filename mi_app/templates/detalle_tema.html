{% extends "base.html" %}

{% block content %}
    <a href="{{ url_for('bloque_detalle', bloque_id=tema.bloque.id) }}" class="text-muted text-decoration-none mb-3 d-inline-block"><i class="bi bi-arrow-left"></i> Volver a {{ tema.bloque.nombre }}</a>
    <h1 class="mb-4">Gestionar Tema: {{ tema.nombre }}</h1>
    <hr>

    <div class="card mb-5" data-aos="fade-up">
        <div class="card-header">
            <h2 class="h4 mb-0"><i class="bi bi-journal-text"></i> Notas / Referencias del Tema</h2>
        </div>
        <div class="card-body">
            {% if tema.notas %}
                <ul class="list-group list-group-flush">
                {% for nota in tema.notas %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span class="fst-italic">{{ nota.texto }}</span>
                        <div class="btn-group">
                            <a href="{{ url_for('editar_nota', nota_id=nota.id) }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-pencil-fill"></i></a>
                            <form method="POST" action="{{ url_for('eliminar_nota', nota_id=nota.id) }}" onsubmit="return confirm('¿Estás seguro de que quieres eliminar esta nota?');">
                                <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash3-fill"></i></button>
                            </form>
                        </div>
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">No hay notas para este tema.</p>
            {% endif %}

            <hr class="my-4">

            <h3 class="h5">Añadir Nueva Nota</h3>
            <form method="POST" action="{{ url_for('detalle_tema', tema_id=tema.id) }}">
                {{ form_nota.hidden_tag() }}
                <div class="input-group">
                    {{ form_nota.texto(class="form-control", placeholder="Ej: Referencia a Normativa...") }}
                    {{ form_nota.submit_nota(class="btn btn-secondary") }}
                </div>
            </form>
        </div>
    </div>


    <div class="card" data-aos="fade-up" data-aos-delay="100">
        <div class="card-header">
             <h2 class="h4 mb-0"><i class="bi bi-patch-question-fill"></i> Preguntas del Tema</h2>
        </div>
        <div class="card-body">
            <h3 class="h5">Añadir Nueva Pregunta</h3>
            <form method="POST" action="{{ url_for('detalle_tema', tema_id=tema.id) }}">
                {{ form_pregunta.hidden_tag() }}
                <fieldset>
                    <div class="mb-3">{{ form_pregunta.texto.label(class="form-label") }} {{ form_pregunta.texto(class="form-control", rows="3") }}</div>
                    <div class="mb-3">{{ form_pregunta.dificultad.label(class="form-label") }} {{ form_pregunta.dificultad(class="form-select") }}</div><hr>
                    <div class="row"><div class="col-md-6 mb-3">{{ form_pregunta.respuesta1_texto.label(class="form-label") }} {{ form_pregunta.respuesta1_texto(class="form-control") }}</div><div class="col-md-6 mb-3">{{ form_pregunta.respuesta2_texto.label(class="form-label") }} {{ form_pregunta.respuesta2_texto(class="form-control") }}</div><div class="col-md-6 mb-3">{{ form_pregunta.respuesta3_texto.label(class="form-label") }} {{ form_pregunta.respuesta3_texto(class="form-control") }}</div><div class="col-md-6 mb-3">{{ form_pregunta.respuesta4_texto.label(class="form-label") }} {{ form_pregunta.respuesta4_texto(class="form-control") }}</div></div>
                    <div class="mb-3">{{ form_pregunta.respuesta_correcta.label(class="form-label") }}<div class="d-flex">{% for subfield in form_pregunta.respuesta_correcta %}<div class="form-check me-3">{{ subfield(class="form-check-input") }} {{ subfield.label(class="form-check-label") }}</div>{% endfor %}</div></div>
                    <div class="mb-3">{{ form_pregunta.retroalimentacion.label(class="form-label") }} {{ form_pregunta.retroalimentacion(class="form-control", rows="2") }}</div>
                </fieldset>
                <div class="d-grid">{{ form_pregunta.submit(class="btn btn-primary", value="Guardar Pregunta") }}</div>
            </form>
            <hr class="my-4">
            <h3 class="h5">Preguntas Existentes</h3>
            {% if tema.preguntas %}
                {% for pregunta in tema.preguntas %}
                    <div class="card mb-3"><div class="card-body"><div class="d-flex justify-content-between align-items-start"><div><p class="fw-bold">{{ loop.index }}. {{ pregunta.texto }}</p><ul class="list-unstyled ms-3"><small>{% for respuesta in pregunta.respuestas %}<li {% if respuesta.es_correcta %} class="text-success fw-bold" {% endif %}>- {{ respuesta.texto }}</li>{% endfor %}</small></ul></div><div class="btn-group"><a href="{{ url_for('editar_pregunta', pregunta_id=pregunta.id) }}" class="btn btn-sm btn-secondary"><i class="bi bi-pencil-fill"></i></a><form method="POST" action="{{ url_for('eliminar_pregunta', pregunta_id=pregunta.id) }}" onsubmit="return confirm('¿Estás seguro?');"><button type="submit" class="btn btn-sm btn-danger"><i class="bi bi-trash3-fill"></i></button></form></div></div></div></div>
                {% endfor %}
            {% else %}
                <p class="text-muted">No hay preguntas en este tema.</p>
            {% endif %}
        </div>
    </div>
{% endblock %}