// mi_app/static/js/agente_ia.js

document.addEventListener('DOMContentLoaded', function() {

    // --- 1. REFERENCIAS A ELEMENTOS DEL DOM ---
    const sourceItems = document.querySelectorAll('.source-item');
    const pdfViewer = document.getElementById('pdf-viewer');
    const viewerPlaceholder = document.getElementById('viewer-placeholder');
    
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-btn');
    const chatHistory = document.getElementById('chat-history');
    
    const tokensDisplay = document.getElementById('remaining-tokens-value');
    
    // --- 2. CONFIGURACIÓN DE PDF.js ---
    const { pdfjsLib } = globalThis;
    if (pdfjsLib) {
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://mozilla.github.io/pdf.js/build/pdf.worker.mjs`;
    } else {
        console.error("PDF.js no está cargado.");
        return;
    }

    // --- 3. FUNCIÓN PARA CARGAR Y RENDERIZAR EL PDF ---
    async function loadPdf(pdfUrl) {
        pdfViewer.innerHTML = `
            <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                <div class="spinner-border me-3" role="status"></div>
                <strong>Cargando documento...</strong>
            </div>`;
        viewerPlaceholder.style.display = 'none';
        pdfViewer.style.display = 'block';

        try {
            const pdf = await pdfjsLib.getDocument(pdfUrl).promise;
            pdfViewer.innerHTML = ''; 

            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                const viewport = page.getViewport({ scale: 1.75 });
                
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                pdfViewer.appendChild(canvas);

                await page.render({ canvasContext: context, viewport: viewport }).promise;
            }
        } catch (error) {
            console.error('Error al cargar el PDF:', error);
            pdfViewer.innerHTML = '<div class="alert alert-danger m-3">Error al cargar el documento. Asegúrate de que es públicamente accesible.</div>';
        }
    }

    // --- 4. EVENT LISTENERS PARA LA LISTA DE TEMAS ---
    sourceItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            
            sourceItems.forEach(i => i.classList.remove('active'));
            this.classList.add('active');

            const gcsPath = this.dataset.path;
            const publicUrl = `https://storage.googleapis.com/${gcsPath.substring(5)}`;
            loadPdf(publicUrl);
        });
    });

    // --- 5. LÓGICA DEL CHAT ---
    function scrollToBottom() {
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function addMessageToChat(sender, content, isThinking = false) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'bot-message');
        
        if (sender === 'user') {
            messageDiv.textContent = content;
        } else if (isThinking) {
            messageDiv.innerHTML = `<div class="d-flex align-items-center"><div class="spinner-border spinner-border-sm me-2" role="status"></div><span>Consultando...</span></div>`;
        } else {
            messageDiv.innerHTML = typeof marked !== 'undefined' ? marked.parse(content) : content.replace(/\n/g, '<br>');
        }
        
        chatHistory.appendChild(messageDiv);
        scrollToBottom();
        return messageDiv;
    }

    if (chatForm) {
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const userMessage = userInput.value.trim();
            if (!userMessage) return;

            const activeSource = document.querySelector('.source-item.active');
            let selectedSources = [];
            if(activeSource) {
                selectedSources.push(activeSource.dataset.path);
            }

            addMessageToChat('user', userMessage);
            userInput.value = '';
            
            const thinkingMessage = addMessageToChat('bot', '', true);

            fetch("/api/consulta-rag", { // <-- LÍNEA CORREGIDA
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: JSON.stringify({ 
                    message: userMessage, 
                    mode: "didactico",
                    selected_sources: selectedSources
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { 
                        throw new Error(err.error || 'Error desconocido del servidor.'); 
                    });
                }
                return response.json();
            })
            .then(data => {
                thinkingMessage.remove();
                addMessageToChat('bot', data.response);
                
                if (data.remaining_tokens !== undefined) {
                    tokensDisplay.textContent = data.remaining_tokens;
                }
            })
            .catch(error => {
                console.error('Error en la consulta RAG:', error);
                thinkingMessage.remove();
                addMessageToChat('bot', `❌ Lo siento, ha ocurrido un error: ${error.message}`);
            });
        });
    }
});