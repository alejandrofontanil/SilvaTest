{% extends "base.html" %}

{% block styles %}
{{ super() }}
<style>
    /* --- NUEVOS ESTILOS PARA LAYOUT Y PANEL DE FUENTES --- */
    #study-environment {
        display: flex;
        gap: 1.5rem; /* Espacio entre el panel de fuentes y el chat */
    }

    #sources-panel {
        flex: 0 0 280px; /* Ancho fijo para el panel de fuentes */
        background-color: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 0.75rem;
        padding: 1.25rem;
        height: fit-content; /* Se ajusta al contenido */
        max-height: 75vh;
        overflow-y: auto;
    }
    
    #sources-panel h5 {
        font-weight: 700;
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--bs-border-color);
        padding-bottom: 0.75rem;
    }
    
    .source-item {
        margin-bottom: 0.5rem;
    }

    #chat-wrapper {
        flex-grow: 1; /* El chat ocupa el resto del espacio */
    }

    /* Estilos generales del contenedor de chat (ya los ten√≠as) */
    #chat-container {
        display: flex;
        flex-direction: column;
        height: 75vh;
        max-height: 800px;
        border: 1px solid var(--bs-border-color);
        border-radius: 0.75rem;
        overflow: hidden;
        background-color: var(--bs-light-bg-subtle);
    }
    #chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
    }
    .chat-message {
        max-width: 85%;
        padding: 0.75rem 1.25rem;
        border-radius: 1.25rem;
        margin-bottom: 1rem;
        line-height: 1.5;
        word-wrap: break-word;
    }
    .user-message {
        background-color: var(--bs-primary);
        color: var(--bs-btn-color, #FFFFFF);
        align-self: flex-end;
        border-bottom-right-radius: 0.25rem;
    }
    .agent-message {
        background-color: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        align-self: flex-start;
        border-bottom-left-radius: 0.25rem;
    }
    .thinking-indicator {
        display: flex;
        align-items: center;
        align-self: flex-start;
        font-style: italic;
        color: var(--bs-secondary-color);
    }
    
    /* --- CAMBIO: MEJORA DE ESTILOS PARA LA PANTALLA DE TOKENS --- */
    #tokens-display {
        font-size: 0.85rem;
        font-weight: 600;
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        border: 1px solid var(--bs-border-color);
        white-space: nowrap;
    }

    /* Colores del recuadro de tokens seg√∫n el estado */
    .tokens-ok {
        background-color: var(--bs-success-bg-subtle);
        border-color: var(--bs-success-border-subtle);
    }

    .tokens-warning {
        background-color: var(--bs-warning-bg-subtle);
        border-color: var(--bs-warning-border-subtle);
    }

    .tokens-danger {
        background-color: var(--bs-danger-bg-subtle);
        border-color: var(--bs-danger-border-subtle);
    }

    /* Estilo para resaltar el nombre de SilvIA */
    .resaltado-silvia {
        color: var(--bs-primary);
        background-color: var(--bs-body-bg);
        padding: 0.1rem 0.4rem;
        border-radius: 0.25rem;
        font-weight: bold;
    }
    
    /* --- ESTILOS PARA EL MODO CUADERNO (ya los ten√≠as) --- */
    .agent-response-content h2 {
        font-size: 1.1rem;
        font-weight: 700;
        margin-top: 1rem;
        padding-bottom: 5px;
        border-bottom: 1px dashed #ced4da;
    }
    .agent-response-content .note-box {
        background-color: #f8f9fa;
        border-left: 4px solid #17a2b8;
        padding: 10px;
        margin-top: 10px;
        border-radius: 0.5rem;
        font-size: 0.9rem;
    }
    .agent-response-content strong {
        font-weight: 700;
        color: var(--bs-primary);
    }
    
    /* --- MEDIA QUERY: AJUSTES PARA PANTALLAS PEQUE√ëAS (M√ìVILES) --- */
    @media (max-width: 992px) {
        #study-environment {
            flex-direction: column;
            gap: 1rem;
        }
        #sources-panel {
            flex: auto;
            max-height: 50vh;
        }
        .container-fluid .row {
            padding: 0 1rem;
        }
        .d-flex.justify-content-between {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4" data-aos="fade-up">
    <div class="row justify-content-center">
        <div class="col-lg-11 col-xl-10">
            <h2 class="text-center mb-4"><i class="bi bi-robot me-2"></i>Asistente de Estudio SilvIA</h2>
            
            <div id="study-environment">

                <aside id="sources-panel" class="shadow-sm">
                    <h5><i class="bi bi-collection-fill me-2"></i>Temario</h5>
                    <div id="sources-list">
                        {% if available_sources %}
                            {% for source in available_sources %}
                            <div class="form-check source-item">
                                <input class="form-check-input source-checkbox" type="checkbox" value="{{ source.path }}" id="source-{{ loop.index }}">
                                <label class="form-check-label" for="source-{{ loop.index }}">
                                    {{ source.name }}
                                </label>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted small">No hay fuentes cargadas.</p>
                        {% endif %}
                    </div>
                    <small class="text-muted mt-3 d-block">Selecciona temas para enfocar la b√∫squeda.</small>
                </aside>

                <div id="chat-wrapper">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="form-group d-flex align-items-center">
                            <label for="response-mode" class="me-2 text-muted fw-bold small">Modo:</label>
                            <select id="response-mode" class="form-select form-select-sm" style="width: auto;">
                                <option value="didactico">üìñ Cuaderno de Estudio</option>
                                <option value="formal">üéØ Respuesta Directa</option>
                            </select>
                        </div>
                        <div id="tokens-display" class="d-flex align-items-center mb-0">
                            Tokens Restantes: <span id="remaining-tokens-value" class="ms-1 fw-bold">{{ rag_tokens_restantes|default(0) }}</span>
                            {% if rag_tokens_restantes < 5000 %}<i class="bi bi-exclamation-triangle-fill text-warning ms-1"></i>{% endif %}
                        </div>
                    </div>
                    
                    <div id="chat-container" class="shadow-lg">
                        <div id="chat-messages">
                            <div class="agent-message chat-message">
                                ¬°Soy <span class="resaltado-silvia">SilvIA</span>, tu Asistente de Estudio IA! Selecciona los temas que quieras repasar en el panel de la izquierda y hazme tu pregunta. ¬°Estoy listo para optimizar tu estudio!
                            </div>
                        </div>
                        
                        <div id="chat-input-container" class="p-3 border-top">
                            <form id="chat-form">
                                <div class="input-group">
                                    <input type="text" id="user-input" class="form-control form-control-lg" placeholder="Ej: ¬øQu√© se considera un 'refugio de pesca'?" autocomplete="off" required>
                                    <button class="btn btn-primary" type="submit" id="send-btn"><i class="bi bi-send-fill"></i></button>
                                </div>
                                <small id="token-limit-message" class="text-danger mt-2" style="display:none;">
                                    Has agotado tus tokens de IA. Contacta con el administrador para recargar.
                                </small>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const chatMessages = document.getElementById('chat-messages');
    const tokensDisplay = document.getElementById('remaining-tokens-value');
    const tokensDisplayContainer = document.getElementById('tokens-display'); // Nuevo elemento
    const limitMessage = document.getElementById('token-limit-message');
    const modeSelect = document.getElementById('response-mode');
    
    let currentTokens = parseInt(tokensDisplay.textContent);

    function updateTokenState(remainingTokens) {
        currentTokens = remainingTokens;
        tokensDisplay.textContent = currentTokens;
        
        const isDisabled = currentTokens <= 0;
        userInput.disabled = isDisabled;
        document.getElementById('send-btn').disabled = isDisabled;
        limitMessage.style.display = isDisabled ? 'block' : 'none';

        // L√≥gica para cambiar el color del recuadro de tokens
        tokensDisplayContainer.classList.remove('tokens-ok', 'tokens-warning', 'tokens-danger');
        if (currentTokens > 15000) {
            tokensDisplayContainer.classList.add('tokens-ok');
        } else if (currentTokens > 5000) {
            tokensDisplayContainer.classList.add('tokens-warning');
        } else {
            tokensDisplayContainer.classList.add('tokens-danger');
        }
    }
    
    updateTokenState(currentTokens);

    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function formatAgentResponse(markdown) {
        let html = markdown.replace(/## üìñ Concepto Clave/g, '<h2>üìñ Concepto Clave</h2>');
        html = html.replace(/## üêü Ejemplo\/Aplicaci√≥n/g, '<h2>üêü Ejemplo/Aplicaci√≥n</h2>');
        html = html.replace(/## üí° Nota de Estudio/g, '<div class="note-box">üí° <strong>Nota de Estudio:</strong> ');
        html = html.replace(/## üìö Fuentes Legales\/Temario/g, '</div><h2 class="mt-3">üìö Fuentes Legales/Temario</h2>');
        
        if (html.includes('<div class="note-box"') && !html.includes('</div>')) {
            html += '</div>';
        }
        
        html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/\n/g, '<br>');
        html = html.replace(/<br>\s*-\s*(.*)/g, '<br>&bull; $1');
        html = html.replace(/<br>\s*\*\s*(.*)/g, '<br>&bull; $1');
        
        return `<div class="agent-response-content">${html}</div>`;
    }

    function addMessageToChat(sender, content, isThinking = false) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'agent-message');
        
        if (sender === 'user') {
            messageDiv.textContent = content;
        } else if (isThinking) {
            messageDiv.classList.add('thinking-indicator');
            messageDiv.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Consultando el Temario...`;
        } else {
            messageDiv.innerHTML = formatAgentResponse(content);
        }
        
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
        return messageDiv;
    }

    function updateAgentMessage(element, newMessage) {
        element.innerHTML = formatAgentResponse(newMessage);
        element.classList.remove('thinking-indicator');
        scrollToBottom();
    }

    chatForm.addEventListener('submit', function (event) {
        event.preventDefault();
        const userMessage = userInput.value.trim();
        const responseMode = modeSelect.value;
        
        const selectedSources = Array.from(document.querySelectorAll('.source-checkbox:checked'))
                                         .map(checkbox => checkbox.value);

        if (userMessage === '' || currentTokens <= 0) return;

        addMessageToChat('user', userMessage);
        userInput.value = '';
        
        const thinkingMessageElement = addMessageToChat('agent', '', true);

        userInput.disabled = true;
        document.getElementById('send-btn').disabled = true;

        fetch("{{ url_for('main.api_consulta_rag') }}", { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: JSON.stringify({ 
                message: userMessage, 
                mode: responseMode,
                selected_sources: selectedSources
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { 
                    throw new Error(err.error || 'Error desconocido del servidor.'); 
                });
            }
            return response.json();
        })
        .then(data => {
            updateAgentMessage(thinkingMessageElement, data.response);
            
            if (data.remaining_tokens !== undefined) {
                updateTokenState(data.remaining_tokens);
            }
        })
        .catch(error => {
            console.error('Error en la consulta RAG:', error);
            updateAgentMessage(thinkingMessageElement, `‚ùå Lo siento, ha ocurrido un error: ${error.message}`);
        })
        .finally(() => {
            if(currentTokens > 0) {
              userInput.disabled = false;
              document.getElementById('send-btn').disabled = false;
              userInput.focus();
            }
        });
    });
});
</script>
{% endblock %}