{% extends "base.html" %}

{% block styles %}
{{ super() }}
<style>
    #chat-container {
        height: 60vh;
        overflow-y: auto;
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        padding: 1rem;
    }
    .chat-message {
        padding: 0.75rem 1rem;
        border-radius: 0.75rem;
        margin-bottom: 0.5rem;
        max-width: 80%;
    }
    .user-message {
        background-color: var(--bs-primary);
        color: var(--bs-btn-color, #FFFFFF);
        margin-left: auto;
        border-bottom-right-radius: 0;
    }
    .agent-message {
        background-color: var(--bs-light-bg-subtle, #f1f1f1);
        border: 1px solid var(--bs-border-color);
        margin-right: auto;
        border-bottom-left-radius: 0;
    }
    .thinking {
        color: var(--bs-secondary-text-emphasis);
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <h1 class="mb-3"><i class="bi bi-robot me-2"></i>Agente de IA Experto</h1>
    <p class="lead text-muted mb-4">Haz una pregunta sobre el temario que has subido. El agente buscará en los documentos para darte una respuesta precisa.</p>

    <div id="chat-container" class="mb-3 bg-body-tertiary">
        </div>

    <form id="chat-form">
        <div class="input-group">
            <input type="text" id="user-input" class="form-control form-control-lg" placeholder="Escribe tu pregunta aquí..." required autocomplete="off">
            <button class="btn btn-primary" type="submit" id="send-btn">
                <span id="send-icon"><i class="bi bi-send-fill"></i></span>
                <span id="loading-spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const chatContainer = document.getElementById('chat-container');
    const sendBtn = document.getElementById('send-btn');
    const sendIcon = document.getElementById('send-icon');
    const loadingSpinner = document.getElementById('loading-spinner');

    function addMessage(content, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('chat-message', `${sender}-message`);
        messageDiv.innerHTML = content;
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    chatForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const userQuery = userInput.value.trim();
        if (!userQuery) return;

        addMessage(userQuery, 'user');
        userInput.value = '';
        userInput.disabled = true;
        sendIcon.style.display = 'none';
        loadingSpinner.style.display = 'inline-block';
        
        addMessage('<div class="thinking">Agente: Pensando...</div>', 'agent');

        fetch("{{ url_for('main.api_agente_ia') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ pregunta: userQuery })
        })
        .then(response => response.json())
        .then(data => {
            const lastMessage = chatContainer.lastElementChild;
            if (data.respuesta) {
                lastMessage.innerHTML = marked.parse(data.respuesta);
                if (data.fuentes && data.fuentes.length > 0) {
                    lastMessage.innerHTML += `<small class="d-block mt-2 text-muted">Fuentes: ${data.fuentes.join(', ')}</small>`;
                }
            } else {
                lastMessage.innerHTML = `<div class="text-danger">${data.error || 'Ocurrió un error.'}</div>`;
            }
        })
        .catch(error => {
            const lastMessage = chatContainer.lastElementChild;
            lastMessage.innerHTML = '<div class="text-danger">Error de conexión. Inténtalo de nuevo.</div>';
            console.error('Error:', error);
        })
        .finally(() => {
            userInput.disabled = false;
            sendIcon.style.display = 'inline-block';
            loadingSpinner.style.display = 'none';
            userInput.focus();
        });
    });
});
</script>
{% endblock %}