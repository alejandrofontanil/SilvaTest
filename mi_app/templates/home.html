{% extends "base.html" %}

{% block content %}

{# =================================================================== #}
{# ===== INICIO DE LA LÓGICA DE VISTAS PARA CADA TIPO DE USUARIO ===== #}
{# =================================================================== #}

{% if current_user.is_authenticated %}

    {# --- VISTA PARA USUARIOS CON SESIÓN INICIADA --- #}

    {% if current_user.es_admin %}

        <div class="text-center my-5" data-aos="fade-up">
            <h1 class="display-5 fw-bold">Panel de Administrador</h1>
            <p class="fs-4 text-muted">Acceso a todas las convocatorias del sistema.</p>
            <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-primary btn-lg mt-3">Ir al Dashboard de Admin</a>
        </div>
        <hr class="my-5">


    {% else %}

        <div class="row g-4 mb-5">
            <div class="col-12">
                <h2 class="mb-4" data-aos="fade-right">¡Bienvenido de nuevo, {{ current_user.nombre }}!</h2>
            </div>
            
            <div class="col-lg-8" data-aos="fade-up">
                <div class="card h-100">
                    <div class="card-body p-4">
                        <h5 class="card-title text-muted mb-3">Evolución de Notas (Últimos 30 días)</h5>
                        <div style="height: 300px;">
                            <canvas id="evolucionNotasChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4" data-aos="fade-up" data-aos-delay="100">
                <div class="card h-100">
                    <div class="card-body p-4">
                        <h5 class="card-title text-muted mb-3">Rendimiento por Bloque</h5>
                        <div style="height: 300px;">
                            <canvas id="radarCompetenciasChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6" data-aos="fade-up" data-aos-delay="200">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title text-muted mb-3">Último Test Realizado</h5>
                        {% if ultimo_resultado %}
                            <p class="fw-bold fs-5">{{ ultimo_resultado.tema.nombre }}</p>
                            <p>Nota: <span class="badge fs-6 {% if ultimo_resultado.nota >= 5 %} text-bg-success {% else %} text-bg-danger {% endif %}">{{ "%.2f"|format(ultimo_resultado.nota) }}</span></p>
                            <a href="{{ url_for('main.repaso_test', resultado_id=ultimo_resultado.id) }}" class="btn btn-outline-primary mt-2">Repasar este Test <i class="bi bi-arrow-right"></i></a>
                        {% else %}
                            <p class="text-muted">Aún no has completado ningún test.</p>
                            <a href="#convocatorias" class="btn btn-primary mt-2">Empezar a practicar <i class="bi bi-arrow-right"></i></a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-md-6" data-aos="fade-up" data-aos-delay="300">
                <div class="card h-100">
                     <div class="card-body">
                        <h5 class="card-title text-muted mb-3">Acceso Rápido a Favoritas</h5>
                        {% if ultimas_favoritas %}
                            <div class="list-group list-group-flush">
                                {% for fav in ultimas_favoritas %}
                                    <a href="{{ url_for('main.hacer_test', tema_id=fav.tema_id) }}#card-pregunta-{{ fav.id }}" class="list-group-item list-group-item-action">
                                        <i class="bi bi-star-fill text-warning me-2"></i>{{ fav.texto|truncate(60) }}
                                    </a>
                                {% endfor %}
                            </div>
                             <a href="{{ url_for('main.preguntas_favoritas') }}" class="btn btn-outline-secondary mt-3 btn-sm">Ver todas</a>
                        {% else %}
                            <p class="text-muted">Marca preguntas con la estrella <i class="bi bi-star"></i> para que aparezcan aquí.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center" data-aos="fade-up" id="convocatorias">
            <h2 class="display-6 fw-bold">Continúa tu preparación</h2>
            <p class="fs-5 text-muted">Selecciona una de tus convocatorias para seguir practicando.</p>
        </div>

    {% endif %}


{% else %}

    <div class="text-center" style="padding: 4rem 0;">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo SilvaTest" class="img-fluid mb-4" style="max-width: 250px;" data-aos="zoom-in">
        <h1 class="display-4 fw-bold" data-aos="fade-up">Aprueba a la Primera con la Preparación Inteligente.</h1>
        <p class="lead text-muted mt-3 mx-auto" style="max-width: 800px;" data-aos="fade-up" data-aos-delay="100">
            Practica con tests oficiales, descubre tus puntos débiles con nuestro Analizador Inteligente y repasa solo lo que necesitas para optimizar tu estudio.
        </p>
        <div class="mt-4" data-aos="fade-up" data-aos-delay="200">
            <a href="{{ url_for('auth.registro') }}" class="btn btn-primary btn-lg px-4">Empezar a Practicar Gratis</a>
            <a href="#convocatorias" class="btn btn-outline-secondary btn-lg px-4 ms-2">Ver Temarios</a>
        </div>
    </div>
    
    <hr class="my-5">

    <div class="row text-center g-4" style="padding: 2rem 0;">
        <div class="col-md-6 col-lg-3" data-aos="fade-up">
            <div class="card h-100 border-0 shadow-sm"> <div class="card-body p-4"> <div class="mb-3"> <i class="bi bi-graph-up-arrow" style="font-size: 3rem; color: var(--bs-primary);"></i> </div> <h3 class="fs-5">Analiza tu Evolución</h3> <p class="text-muted small">Con nuestros gráficos de Evolución de Notas, visualiza tu progreso día a día y mantén la motivación viendo cómo mejoras.</p> </div> </div>
        </div>
        <div class="col-md-6 col-lg-3" data-aos="fade-up" data-aos-delay="100">
            <div class="card h-100 border-0 shadow-sm"> <div class="card-body p-4"> <div class="mb-3"> <i class="bi bi-search" style="font-size: 3rem; color: var(--bs-primary);"></i> </div> <h3 class="fs-5">Descubre tus Puntos Débiles</h3> <p class="text-muted small">Nuestras Estadísticas detalladas te muestran en qué temas y bloques fallas más para que sepas dónde tienes que reforzar.</p> </div> </div>
        </div>
        <div class="col-md-6 col-lg-3" data-aos="fade-up" data-aos-delay="200">
            <div class="card h-100 border-0 shadow-sm"> <div class="card-body p-4"> <div class="mb-3"> <i class="bi bi-recycle" style="font-size: 3rem; color: var(--bs-primary);"></i> </div> <h3 class="fs-5">Repasa Fallos de Forma Inteligente</h3> <p class="text-muted small">Nuestra herramienta crea tests solo con las preguntas que has fallado, para un estudio 100% eficiente.</p> </div> </div>
        </div>
        <div class="col-md-6 col-lg-3" data-aos="fade-up" data-aos-delay="300">
            <div class="card h-100 border-0 shadow-sm"> <div class="card-body p-4"> <div class="mb-3"> <i class="bi bi-tools" style="font-size: 3rem; color: var(--bs-primary);"></i> </div> <h3 class="fs-5">Crea Exámenes a tu Medida</h3> <p class="text-muted small">Con el Generador de Tests, puedes crear simulacros personalizados, eligiendo los temas y el número de preguntas.</p> </div> </div>
        </div>
    </div>
    
    <hr class="my-5">

    <div class="text-center" data-aos="fade-up" id="convocatorias">
        <h2 class="display-6 fw-bold">Comienza tu Preparación Ahora</h2>
        <p class="fs-5 text-muted">Selecciona uno de nuestros temarios disponibles.</p>
    </div>

{% endif %}


<div class="row g-4 mt-4">
    {% if convocatorias %}
        {% for convocatoria in convocatorias %}
            <div class="col-lg-6" data-aos="fade-up" data-aos-delay="{{ loop.index0 * 100 }}">
                <a href="{{ url_for('main.convocatoria_detalle', convocatoria_id=convocatoria.id) }}" class="text-decoration-none">
                    <div class="card card-convocatoria h-100">
                        <div class="card-body text-center d-flex flex-column justify-content-center p-4">
                            <h3 class="card-title">{{ convocatoria.nombre }}</h3>
                            <p class="mb-0 mt-2">Acceder al temario <i class="bi bi-arrow-right-circle"></i></p>
                        </div>
                    </div>
                </a>
            </div>
        {% endfor %}
    {% else %}
        <div class="col-12">
            {% if current_user.is_authenticated %}
            <p class="text-center text-muted">Parece que aún no tienes acceso a ninguna convocatoria. Ponte en contacto con el administrador.</p>
            {% else %}
            <p class="text-center text-muted">Aún no hay convocatorias públicas disponibles.</p>
            {% endif %}
        </div>
    {% endif %}
</div>

<style>
    .card-convocatoria {
        transition: all 0.3s ease;
        border-width: 2px;
    }
    .card-convocatoria:hover {
        transform: translateY(-10px);
        box-shadow: 0 1rem 3rem rgba(0,0,0,.175)!important;
        border-color: var(--bs-primary);
    }
    .card-convocatoria h3 {
        color: var(--bs-secondary-text-emphasis);
    }
    .card-convocatoria p {
        color: var(--bs-primary);
    }
</style>
{% endblock %}


{% block scripts %}
{{ super() if super }}
<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- LÓGICA PARA EL GRÁFICO DE LÍNEAS (EVOLUCIÓN) ---
    const chartEvolucionCanvas = document.getElementById('evolucionNotasChart');
    if (chartEvolucionCanvas) {
        fetch("{{ url_for('main.api_evolucion_notas') }}")
            .then(response => response.json())
            .then(data => {
                const ctx = chartEvolucionCanvas.getContext('2d');
                if (!data || data.labels.length === 0) {
                    ctx.font = "16px 'Lato', sans-serif";
                    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--bs-body-color');
                    ctx.textAlign = "center";
                    ctx.fillText("Realiza algunos tests para ver tu evolución aquí.", chartEvolucionCanvas.width / 2, chartEvolucionCanvas.height / 2);
                    return;
                }
                const esModoOscuro = document.documentElement.getAttribute('data-bs-theme') === 'dark';
                const colorTexto = esModoOscuro ? 'rgba(234, 234, 234, 0.8)' : 'rgba(73, 80, 87, 0.8)';
                const colorGrid = esModoOscuro ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                const colorBordeGrafico = esModoOscuro ? '#8AB4F8' : '#2E7D32';
                const colorFondoGrafico = esModoOscuro ? 'rgba(138, 180, 248, 0.2)' : 'rgba(46, 125, 50, 0.2)';
                new Chart(chartEvolucionCanvas, {
                    type: 'line', data: { labels: data.labels, datasets: [{ label: 'Nota Media Diaria', data: data.data, fill: true, borderColor: colorBordeGrafico, backgroundColor: colorFondoGrafico, tension: 0.3, pointBackgroundColor: colorBordeGrafico, pointRadius: 4 }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 10, ticks: { color: colorTexto }, grid: { color: colorGrid } }, x: { ticks: { color: colorTexto }, grid: { color: colorGrid } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(context) { return 'Nota media: ' + context.parsed.y; } } } } }
                });
            })
            .catch(error => console.error("Error al cargar datos del gráfico de evolución:", error));
    }

    // --- LÓGICA PARA EL GRÁFICO RADAR (COMPETENCIAS) ---
    const chartRadarCanvas = document.getElementById('radarCompetenciasChart');
    if (chartRadarCanvas) {
        fetch("{{ url_for('main.api_radar_competencias') }}")
            .then(response => response.json())
            .then(data => {
                const ctx = chartRadarCanvas.getContext('2d');
                if (!data || data.labels.length < 3) { // Radar necesita al menos 3 puntos para verse bien
                    ctx.font = "14px 'Lato', sans-serif";
                    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--bs-body-color');
                    ctx.textAlign = "center";
                    ctx.fillText("Completa tests en al menos 3 bloques", chartRadarCanvas.width / 2, chartRadarCanvas.height / 2 - 10);
                    ctx.fillText("para ver tu radar de competencias.", chartRadarCanvas.width / 2, chartRadarCanvas.height / 2 + 10);
                    return;
                }
                const esModoOscuro = document.documentElement.getAttribute('data-bs-theme') === 'dark';
                const colorTexto = esModoOscuro ? 'rgba(234, 234, 234, 0.8)' : 'rgba(73, 80, 87, 0.8)';
                const colorGrid = esModoOscuro ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                const colorBordeGrafico = esModoOscuro ? '#8AB4F8' : '#2E7D32';
                const colorFondoGrafico = esModoOscuro ? 'rgba(138, 180, 248, 0.2)' : 'rgba(46, 125, 50, 0.2)';
                new Chart(chartRadarCanvas, {
                    type: 'radar', data: { labels: data.labels, datasets: [{ label: 'Nota Media por Bloque', data: data.data, fill: true, backgroundColor: colorFondoGrafico, borderColor: colorBordeGrafico, pointBackgroundColor: colorBordeGrafico, pointBorderColor: '#fff', pointHoverBackgroundColor: '#fff', pointHoverBorderColor: colorBordeGrafico }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { r: { beginAtZero: true, max: 10, pointLabels: { color: colorTexto, font: {size: 12} }, grid: { color: colorGrid }, angleLines: { color: colorGrid } } }, plugins: { legend: { display: false } } }
                });
            })
            .catch(error => console.error("Error al cargar datos del gráfico radar:", error));
    }
});
</script>
{% endblock %}