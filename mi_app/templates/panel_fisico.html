{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const esModoOscuro = document.documentElement.getAttribute('data-bs-theme') === 'dark';
    const colorTexto = esModoOscuro ? 'rgba(234, 234, 234, 0.8)' : 'rgba(73, 80, 87, 0.8)';
    const colorGrid = esModoOscuro ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
    let progresoGeneralChart, cargaKmChart;

    // =============================================
    // === CÓDIGO DE LOS GRÁFICOS (RESTAURADO) ===
    // =============================================
    const progresoCtx = document.getElementById('progresoGeneralChart');
    if (progresoCtx) {
        progresoGeneralChart = new Chart(progresoCtx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [{{ progreso_general_pct }}, 100 - {{ progreso_general_pct }}],
                    backgroundColor: [ esModoOscuro ? '#8AB4F8' : '#2E7D32', 'transparent' ],
                    borderColor: [ esModoOscuro ? '#8AB4F8' : '#2E7D32', esModoOscuro ? '#444746' : '#dee2e6'],
                    borderWidth: 2
                }]
            },
            options: { responsive: true, cutout: '75%', plugins: { legend: { display: false }, tooltip: { enabled: false } } }
        });
    }

    const cargaKmCtx = document.getElementById('cargaKmChart');
    if (cargaKmCtx) {
        cargaKmChart = new Chart(cargaKmCtx, {
            type: 'bar',
            data: {
                labels: {{ labels_grafico_km|tojson }},
                datasets: [
                    {
                        label: 'KM Objetivo',
                        data: {{ km_objetivo_data|tojson }},
                        backgroundColor: 'rgba(128, 128, 128, 0.2)',
                        borderColor: 'rgba(128, 128, 128, 0.5)',
                        borderWidth: 1
                    },
                    {
                        label: 'KM Reales',
                        data: {{ km_reales_data|tojson }},
                        backgroundColor: esModoOscuro ? 'rgba(138, 180, 248, 0.6)' : 'rgba(46, 125, 50, 0.6)',
                        borderColor: esModoOscuro ? '#8AB4F8' : '#2E7D32',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { ticks: { color: colorTexto }, grid: { color: colorGrid } },
                    x: { ticks: { color: colorTexto }, grid: { color: colorGrid } }
                },
                plugins: { legend: { labels: { color: colorTexto } } }
            }
        });
    }

    // ==========================================================
    // === LÓGICA PARA FORMULARIO EN LÍNEA (LA QUE YA FUNCIONA) ===
    // ==========================================================
    const botonesRegistrar = document.querySelectorAll('.btn-expand-registrar');
    let activeFormRow = null;

    botonesRegistrar.forEach(button => {
        button.addEventListener('click', function (event) {
            if (activeFormRow) {
                activeFormRow.remove();
                activeFormRow = null;
            }

            const clickedButton = event.currentTarget;
            const semanaId = clickedButton.dataset.semanaId;
            const semanaNum = clickedButton.dataset.semanaNum;
            const dia = clickedButton.dataset.dia;
            const clickedRow = document.getElementById(`semana-row-${semanaId}`);

            const formHtml = `
                <td colspan="6" class="p-3">
                    <div class="card card-body bg-light border-2">
                        <h6 class="mb-3">Registrar Entreno: Semana ${semanaNum}, Día ${dia}</h6>
                        <form class="registro-en-linea-form" data-semana-id="${semanaId}" data-dia="${dia}">
                            <div class="row g-2 align-items-end">
                                <div class="col-sm">
                                    <label class="form-label small">KM Realizados</label>
                                    <input type="number" step="0.1" min="0" class="form-control form-control-sm" name="km_realizados" required>
                                </div>
                                <div class="col-sm">
                                    <label class="form-label small">Sensación</label>
                                    <select class="form-select form-select-sm" name="sensacion_usuario" required>
                                        <option value="" disabled selected>-- Elige --</option>
                                        <option value="De sobra">🟢 De sobra</option>
                                        <option value="Bien">🔵 Bien</option>
                                        <option value="Justo">🟡 Justo</option>
                                        <option value="Muy justo">🟠 Muy justo</option>
                                        <option value="Mal">🔴 Mal</option>
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <button type="submit" class="btn btn-primary btn-sm">Guardar</button>
                                </div>
                                <div class="col-auto">
                                    <button type="button" class="btn btn-secondary btn-sm btn-cancelar-inline">Cancelar</button>
                                </div>
                            </div>
                            <div class="form-error-inline text-danger small mt-2"></div>
                        </form>
                    </div>
                </td>`;

            const formRow = document.createElement('tr');
            formRow.innerHTML = formHtml;
            clickedRow.after(formRow);
            activeFormRow = formRow;

            formRow.querySelector('.btn-cancelar-inline').addEventListener('click', () => {
                formRow.remove();
                activeFormRow = null;
            });

            formRow.querySelector('.registro-en-linea-form').addEventListener('submit', function (e) {
                e.preventDefault();
                const form = e.currentTarget;
                const submitButton = form.querySelector('button[type="submit"]');
                const errorDiv = form.querySelector('.form-error-inline');
                
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
                errorDiv.textContent = '';

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                data.semana_id = form.dataset.semanaId;
                data.dia_entreno = form.dataset.dia;

                fetch("{{ url_for('main.registrar_entrenamiento') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        window.location.reload();
                    } else {
                        errorDiv.textContent = result.error || 'Ocurrió un error.';
                        submitButton.disabled = false;
                        submitButton.innerHTML = 'Guardar';
                    }
                })
                .catch(error => {
                    errorDiv.textContent = 'Error de conexión.';
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Guardar';
                });
            });
        });
    });
});
</script>
{% endblock %}